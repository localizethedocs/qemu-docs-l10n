

<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" data-content_root="../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Integration testing with Avocado &mdash; QEMU 9.2.4 文档</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=7ab3649f" />
      <link rel="stylesheet" type="text/css" href="../../_static/theme_overrides.css?v=46f80001" />

  
    <link rel="shortcut icon" href="../../_static/qemu_32x32.png"/>
    <link rel="canonical" href="https://projects.localizethedocs.org/qemu-docs-l10n/devel/testing/avocado.html" />
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=a816300e"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../../_static/translations.js?v=beaddf03"></script>
      <script src="../../_static/custom.js?v=2ab9f71d"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="搜索" href="../../search.html" />
    <link rel="next" title="ACPI/SMBIOS testing using biosbits" href="acpi-bits.html" />
    <link rel="prev" title="Functional testing with Python" href="functional.html" />
 
<script type="text/javascript" src="../../ltd-provenance.js"></script>
<script type="text/javascript" src="../../ltd-current.js"></script>
<script type="text/javascript" src="../../../../ltd-config.js"></script>
<script type="text/javascript" src="../../../../ltd-flyout.js"></script>

</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #802400" >

          
          
          <a href="../../index.html" class="icon icon-home">
            QEMU
              <img src="../../_static/qemu_128x128.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="搜索文档" aria-label="搜索文档" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="导航菜单">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../about/index.html">About QEMU</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../system/index.html">System Emulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user/index.html">User Mode Emulation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/index.html">Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../interop/index.html">System Emulation Management and Interoperability</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../specs/index.html">System Emulation Guest Hardware Specifications</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Developer Information</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../index-process.html">QEMU Community Processes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index-build.html">QEMU Build System</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Testing QEMU</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="main.html">Testing in QEMU</a></li>
<li class="toctree-l3"><a class="reference internal" href="qtest.html">QTest Device Emulation Testing Framework</a></li>
<li class="toctree-l3"><a class="reference internal" href="functional.html">Functional testing with Python</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Integration testing with Avocado</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#running-tests">Running tests</a></li>
<li class="toctree-l4"><a class="reference internal" href="#manual-installation">Manual Installation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#overview">Overview</a></li>
<li class="toctree-l4"><a class="reference internal" href="#qemumachine">QEMUMachine</a></li>
<li class="toctree-l4"><a class="reference internal" href="#attribute-reference">Attribute reference</a></li>
<li class="toctree-l4"><a class="reference internal" href="#parameter-reference">Parameter reference</a></li>
<li class="toctree-l4"><a class="reference internal" href="#skipping-tests">Skipping tests</a></li>
<li class="toctree-l4"><a class="reference internal" href="#uninstalling-avocado">Uninstalling Avocado</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="acpi-bits.html">ACPI/SMBIOS testing using biosbits</a></li>
<li class="toctree-l3"><a class="reference internal" href="ci.html">CI</a></li>
<li class="toctree-l3"><a class="reference internal" href="fuzzing.html">Fuzzing</a></li>
<li class="toctree-l3"><a class="reference internal" href="blkdebug.html">Block I/O error injection using <code class="docutils literal notranslate"><span class="pre">blkdebug</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="blkverify.html">Block driver correctness testing with <code class="docutils literal notranslate"><span class="pre">blkverify</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../index-api.html">Internal QEMU APIs</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index-internals.html">Internal Subsystem Information</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index-tcg.html">TCG Emulation</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="移动版导航菜单"  style="background: #802400" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">QEMU</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="页面导航">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Developer Information</a></li>
          <li class="breadcrumb-item"><a href="index.html">Testing QEMU</a></li>
      <li class="breadcrumb-item active">Integration testing with Avocado</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://gitlab.com/qemu-project/qemu/blob/master/docs/devel/testing/avocado.rst" class="fa fa-gitlab"> 在 GitLab 上编辑</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="integration-testing-with-avocado">
<span id="checkavocado-ref"></span><h1>Integration testing with Avocado<a class="headerlink" href="#integration-testing-with-avocado" title="Link to this heading"></a></h1>
<p>The <code class="docutils literal notranslate"><span class="pre">tests/avocado</span></code> directory hosts integration tests. They're usually
higher level tests, and may interact with external resources and with
various guest operating systems.</p>
<p>These tests are written using the Avocado Testing Framework (which must be
installed separately) in conjunction with a the <code class="docutils literal notranslate"><span class="pre">avocado_qemu.QemuSystemTest</span></code>
class, implemented at <code class="docutils literal notranslate"><span class="pre">tests/avocado/avocado_qemu</span></code>.</p>
<p>Tests based on <code class="docutils literal notranslate"><span class="pre">avocado_qemu.QemuSystemTest</span></code> can easily:</p>
<blockquote>
<div><ul class="simple">
<li><p>Customize the command line arguments given to the convenience
<code class="docutils literal notranslate"><span class="pre">self.vm</span></code> attribute (a QEMUMachine instance)</p></li>
<li><p>Interact with the QEMU monitor, send QMP commands and check
their results</p></li>
<li><p>Interact with the guest OS, using the convenience console device
(which may be useful to assert the effectiveness and correctness of
command line arguments or QMP commands)</p></li>
<li><p>Interact with external data files that accompany the test itself
(see <code class="docutils literal notranslate"><span class="pre">self.get_data()</span></code>)</p></li>
<li><p>Download (and cache) remote data files, such as firmware and kernel
images</p></li>
<li><p>Have access to a library of guest OS images (by means of the
<code class="docutils literal notranslate"><span class="pre">avocado.utils.vmimage</span></code> library)</p></li>
<li><p>Make use of various other test related utilities available at the
test class itself and at the utility library:</p>
<ul>
<li><p><a class="reference external" href="http://avocado-framework.readthedocs.io/en/latest/api/test/avocado.html#avocado.Test">http://avocado-framework.readthedocs.io/en/latest/api/test/avocado.html#avocado.Test</a></p></li>
<li><p><a class="reference external" href="http://avocado-framework.readthedocs.io/en/latest/api/utils/avocado.utils.html">http://avocado-framework.readthedocs.io/en/latest/api/utils/avocado.utils.html</a></p></li>
</ul>
</li>
</ul>
</div></blockquote>
<section id="running-tests">
<h2>Running tests<a class="headerlink" href="#running-tests" title="Link to this heading"></a></h2>
<p>You can run the avocado tests simply by executing:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">check</span><span class="o">-</span><span class="n">avocado</span>
</pre></div>
</div>
<p>This involves the automatic installation, from PyPI, of all the
necessary avocado-framework dependencies into the QEMU venv within the
build tree (at <code class="docutils literal notranslate"><span class="pre">./pyvenv</span></code>). Test results are also saved within the
build tree (at <code class="docutils literal notranslate"><span class="pre">tests/results</span></code>).</p>
<p>Note: the build environment must be using a Python 3 stack, and have
the <code class="docutils literal notranslate"><span class="pre">venv</span></code> and <code class="docutils literal notranslate"><span class="pre">pip</span></code> packages installed.  If necessary, make sure
<code class="docutils literal notranslate"><span class="pre">configure</span></code> is called with <code class="docutils literal notranslate"><span class="pre">--python=</span></code> and that those modules are
available.  On Debian and Ubuntu based systems, depending on the
specific version, they may be on packages named <code class="docutils literal notranslate"><span class="pre">python3-venv</span></code> and
<code class="docutils literal notranslate"><span class="pre">python3-pip</span></code>.</p>
<p>It is also possible to run tests based on tags using the
<code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">check-avocado</span></code> command and the <code class="docutils literal notranslate"><span class="pre">AVOCADO_TAGS</span></code> environment
variable:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">check</span><span class="o">-</span><span class="n">avocado</span> <span class="n">AVOCADO_TAGS</span><span class="o">=</span><span class="n">quick</span>
</pre></div>
</div>
<p>Note that tags separated with commas have an AND behavior, while tags
separated by spaces have an OR behavior. For more information on Avocado
tags, see:</p>
<blockquote>
<div><p><a class="reference external" href="https://avocado-framework.readthedocs.io/en/latest/guides/user/chapters/tags.html">https://avocado-framework.readthedocs.io/en/latest/guides/user/chapters/tags.html</a></p>
</div></blockquote>
<p>To run a single test file, a couple of them, or a test within a file
using the <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">check-avocado</span></code> command, set the <code class="docutils literal notranslate"><span class="pre">AVOCADO_TESTS</span></code>
environment variable with the test files or test names. To run all
tests from a single file, use:</p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>make check-avocado AVOCADO_TESTS=$FILEPATH
</pre></div>
</div>
</div></blockquote>
<p>The same is valid to run tests from multiple test files:</p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">check</span><span class="o">-</span><span class="n">avocado</span> <span class="n">AVOCADO_TESTS</span><span class="o">=</span><span class="s1">&#39;$FILEPATH1 $FILEPATH2&#39;</span>
</pre></div>
</div>
</div></blockquote>
<p>To run a single test within a file, use:</p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>make check-avocado AVOCADO_TESTS=$FILEPATH:$TESTCLASS.$TESTNAME
</pre></div>
</div>
</div></blockquote>
<p>The same is valid to run single tests from multiple test files:</p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">check</span><span class="o">-</span><span class="n">avocado</span> <span class="n">AVOCADO_TESTS</span><span class="o">=</span><span class="s1">&#39;$FILEPATH1:$TESTCLASS1.$TESTNAME1 $FILEPATH2:$TESTCLASS2.$TESTNAME2&#39;</span>
</pre></div>
</div>
</div></blockquote>
<p>The scripts installed inside the virtual environment may be used
without an &quot;activation&quot;.  For instance, the Avocado test runner
may be invoked by running:</p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>pyvenv/bin/avocado run $OPTION1 $OPTION2 tests/avocado/
</pre></div>
</div>
</div></blockquote>
<p>Note that if <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">check-avocado</span></code> was not executed before, it is
possible to create the Python virtual environment with the dependencies
needed running:</p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">make</span> <span class="n">check</span><span class="o">-</span><span class="n">venv</span>
</pre></div>
</div>
</div></blockquote>
<p>It is also possible to run tests from a single file or a single test within
a test file. To run tests from a single file within the build tree, use:</p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>pyvenv/bin/avocado run tests/avocado/$TESTFILE
</pre></div>
</div>
</div></blockquote>
<p>To run a single test within a test file, use:</p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>pyvenv/bin/avocado run tests/avocado/$TESTFILE:$TESTCLASS.$TESTNAME
</pre></div>
</div>
</div></blockquote>
<p>Valid test names are visible in the output from any previous execution
of Avocado or <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">check-avocado</span></code>, and can also be queried using:</p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pyvenv</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">avocado</span> <span class="nb">list</span> <span class="n">tests</span><span class="o">/</span><span class="n">avocado</span>
</pre></div>
</div>
</div></blockquote>
</section>
<section id="manual-installation">
<h2>Manual Installation<a class="headerlink" href="#manual-installation" title="Link to this heading"></a></h2>
<p>To manually install Avocado and its dependencies, run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pip</span> <span class="n">install</span> <span class="o">--</span><span class="n">user</span> <span class="n">avocado</span><span class="o">-</span><span class="n">framework</span>
</pre></div>
</div>
<p>Alternatively, follow the instructions on this link:</p>
<blockquote>
<div><p><a class="reference external" href="https://avocado-framework.readthedocs.io/en/latest/guides/user/chapters/installing.html">https://avocado-framework.readthedocs.io/en/latest/guides/user/chapters/installing.html</a></p>
</div></blockquote>
</section>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Link to this heading"></a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">tests/avocado/avocado_qemu</span></code> directory provides the
<code class="docutils literal notranslate"><span class="pre">avocado_qemu</span></code> Python module, containing the <code class="docutils literal notranslate"><span class="pre">avocado_qemu.QemuSystemTest</span></code>
class.  Here's a simple usage example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">avocado_qemu</span><span class="w"> </span><span class="kn">import</span> <span class="n">QemuSystemTest</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Version</span><span class="p">(</span><span class="n">QemuSystemTest</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    :avocado: tags=quick</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_qmp_human_info_version</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">launch</span><span class="p">()</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">cmd</span><span class="p">(</span><span class="s1">&#39;human-monitor-command&#39;</span><span class="p">,</span>
                          <span class="n">command_line</span><span class="o">=</span><span class="s1">&#39;info version&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertRegex</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;^(\d+\.\d+\.\d)&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>To execute your test, run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">avocado</span> <span class="n">run</span> <span class="n">version</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<p>Tests may be classified according to a convention by using docstring
directives such as <code class="docutils literal notranslate"><span class="pre">:avocado:</span> <span class="pre">tags=TAG1,TAG2</span></code>.  To run all tests
in the current directory, tagged as &quot;quick&quot;, run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">avocado</span> <span class="n">run</span> <span class="o">-</span><span class="n">t</span> <span class="n">quick</span> <span class="o">.</span>
</pre></div>
</div>
<section id="the-avocado-qemu-qemusystemtest-base-test-class">
<h3>The <code class="docutils literal notranslate"><span class="pre">avocado_qemu.QemuSystemTest</span></code> base test class<a class="headerlink" href="#the-avocado-qemu-qemusystemtest-base-test-class" title="Link to this heading"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">avocado_qemu.QemuSystemTest</span></code> class has a number of characteristics
that are worth being mentioned right away.</p>
<p>First of all, it attempts to give each test a ready to use QEMUMachine
instance, available at <code class="docutils literal notranslate"><span class="pre">self.vm</span></code>.  Because many tests will tweak the
QEMU command line, launching the QEMUMachine (by using <code class="docutils literal notranslate"><span class="pre">self.vm.launch()</span></code>)
is left to the test writer.</p>
<p>The base test class has also support for tests with more than one
QEMUMachine. The way to get machines is through the <code class="docutils literal notranslate"><span class="pre">self.get_vm()</span></code>
method which will return a QEMUMachine instance. The <code class="docutils literal notranslate"><span class="pre">self.get_vm()</span></code>
method accepts arguments that will be passed to the QEMUMachine creation
and also an optional <code class="docutils literal notranslate"><span class="pre">name</span></code> attribute so you can identify a specific
machine and get it more than once through the tests methods. A simple
and hypothetical example follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">avocado_qemu</span><span class="w"> </span><span class="kn">import</span> <span class="n">QemuSystemTest</span>


<span class="k">class</span><span class="w"> </span><span class="nc">MultipleMachines</span><span class="p">(</span><span class="n">QemuSystemTest</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">test_multiple_machines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">first_machine</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_vm</span><span class="p">()</span>
        <span class="n">second_machine</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_vm</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_vm</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;third_machine&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">launch</span><span class="p">()</span>

        <span class="n">first_machine</span><span class="o">.</span><span class="n">launch</span><span class="p">()</span>
        <span class="n">second_machine</span><span class="o">.</span><span class="n">launch</span><span class="p">()</span>

        <span class="n">first_res</span> <span class="o">=</span> <span class="n">first_machine</span><span class="o">.</span><span class="n">cmd</span><span class="p">(</span>
            <span class="s1">&#39;human-monitor-command&#39;</span><span class="p">,</span>
            <span class="n">command_line</span><span class="o">=</span><span class="s1">&#39;info version&#39;</span><span class="p">)</span>

        <span class="n">second_res</span> <span class="o">=</span> <span class="n">second_machine</span><span class="o">.</span><span class="n">cmd</span><span class="p">(</span>
            <span class="s1">&#39;human-monitor-command&#39;</span><span class="p">,</span>
            <span class="n">command_line</span><span class="o">=</span><span class="s1">&#39;info version&#39;</span><span class="p">)</span>

        <span class="n">third_res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_vm</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;third_machine&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">cmd</span><span class="p">(</span>
            <span class="s1">&#39;human-monitor-command&#39;</span><span class="p">,</span>
            <span class="n">command_line</span><span class="o">=</span><span class="s1">&#39;info version&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">first_res</span><span class="p">,</span> <span class="n">second_res</span><span class="p">,</span> <span class="n">third_res</span><span class="p">)</span>
</pre></div>
</div>
<p>At test &quot;tear down&quot;, <code class="docutils literal notranslate"><span class="pre">avocado_qemu.QemuSystemTest</span></code> handles all the
QEMUMachines shutdown.</p>
</section>
<section id="the-avocado-qemu-linuxtest-base-test-class">
<h3>The <code class="docutils literal notranslate"><span class="pre">avocado_qemu.LinuxTest</span></code> base test class<a class="headerlink" href="#the-avocado-qemu-linuxtest-base-test-class" title="Link to this heading"></a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">avocado_qemu.LinuxTest</span></code> is further specialization of the
<code class="docutils literal notranslate"><span class="pre">avocado_qemu.QemuSystemTest</span></code> class, so it contains all the characteristics
of the later plus some extra features.</p>
<p>First of all, this base class is intended for tests that need to
interact with a fully booted and operational Linux guest.  At this
time, it uses a Fedora 31 guest image.  The most basic example looks
like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">avocado_qemu</span><span class="w"> </span><span class="kn">import</span> <span class="n">LinuxTest</span>


<span class="k">class</span><span class="w"> </span><span class="nc">SomeTest</span><span class="p">(</span><span class="n">LinuxTest</span><span class="p">):</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">test</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">launch_and_wait</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ssh_command</span><span class="p">(</span><span class="s1">&#39;some_command_to_be_run_in_the_guest&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Please refer to tests that use <code class="docutils literal notranslate"><span class="pre">avocado_qemu.LinuxTest</span></code> under
<code class="docutils literal notranslate"><span class="pre">tests/avocado</span></code> for more examples.</p>
</section>
</section>
<section id="qemumachine">
<h2>QEMUMachine<a class="headerlink" href="#qemumachine" title="Link to this heading"></a></h2>
<p>The QEMUMachine API is already widely used in the Python iotests,
device-crash-test and other Python scripts.  It's a wrapper around the
execution of a QEMU binary, giving its users:</p>
<blockquote>
<div><ul class="simple">
<li><p>the ability to set command line arguments to be given to the QEMU
binary</p></li>
<li><p>a ready to use QMP connection and interface, which can be used to
send commands and inspect its results, as well as asynchronous
events</p></li>
<li><p>convenience methods to set commonly used command line arguments in
a more succinct and intuitive way</p></li>
</ul>
</div></blockquote>
<section id="qemu-binary-selection">
<h3>QEMU binary selection<a class="headerlink" href="#qemu-binary-selection" title="Link to this heading"></a></h3>
<p>The QEMU binary used for the <code class="docutils literal notranslate"><span class="pre">self.vm</span></code> QEMUMachine instance will
primarily depend on the value of the <code class="docutils literal notranslate"><span class="pre">qemu_bin</span></code> parameter.  If it's
not explicitly set, its default value will be the result of a dynamic
probe in the same source tree.  A suitable binary will be one that
targets the architecture matching host machine.</p>
<p>Based on this description, test writers will usually rely on one of
the following approaches:</p>
<ol class="arabic simple">
<li><p>Set <code class="docutils literal notranslate"><span class="pre">qemu_bin</span></code>, and use the given binary</p></li>
<li><p>Do not set <code class="docutils literal notranslate"><span class="pre">qemu_bin</span></code>, and use a QEMU binary named like
&quot;qemu-system-${arch}&quot;, either in the current
working directory, or in the current source tree.</p></li>
</ol>
<p>The resulting <code class="docutils literal notranslate"><span class="pre">qemu_bin</span></code> value will be preserved in the
<code class="docutils literal notranslate"><span class="pre">avocado_qemu.QemuSystemTest</span></code> as an attribute with the same name.</p>
</section>
</section>
<section id="attribute-reference">
<h2>Attribute reference<a class="headerlink" href="#attribute-reference" title="Link to this heading"></a></h2>
<section id="test">
<h3>Test<a class="headerlink" href="#test" title="Link to this heading"></a></h3>
<p>Besides the attributes and methods that are part of the base
<code class="docutils literal notranslate"><span class="pre">avocado.Test</span></code> class, the following attributes are available on any
<code class="docutils literal notranslate"><span class="pre">avocado_qemu.QemuSystemTest</span></code> instance.</p>
<section id="vm">
<h4>vm<a class="headerlink" href="#vm" title="Link to this heading"></a></h4>
<p>A QEMUMachine instance, initially configured according to the given
<code class="docutils literal notranslate"><span class="pre">qemu_bin</span></code> parameter.</p>
</section>
<section id="arch">
<h4>arch<a class="headerlink" href="#arch" title="Link to this heading"></a></h4>
<p>The architecture can be used on different levels of the stack, e.g. by
the framework or by the test itself.  At the framework level, it will
currently influence the selection of a QEMU binary (when one is not
explicitly given).</p>
<p>Tests are also free to use this attribute value, for their own needs.
A test may, for instance, use the same value when selecting the
architecture of a kernel or disk image to boot a VM with.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">arch</span></code> attribute will be set to the test parameter of the same
name.  If one is not given explicitly, it will either be set to
<code class="docutils literal notranslate"><span class="pre">None</span></code>, or, if the test is tagged with one (and only one)
<code class="docutils literal notranslate"><span class="pre">:avocado:</span> <span class="pre">tags=arch:VALUE</span></code> tag, it will be set to <code class="docutils literal notranslate"><span class="pre">VALUE</span></code>.</p>
</section>
<section id="cpu">
<h4>cpu<a class="headerlink" href="#cpu" title="Link to this heading"></a></h4>
<p>The cpu model that will be set to all QEMUMachine instances created
by the test.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">cpu</span></code> attribute will be set to the test parameter of the same
name. If one is not given explicitly, it will either be set to
<code class="docutils literal notranslate"><span class="pre">None</span> <span class="pre">``,</span> <span class="pre">or,</span> <span class="pre">if</span> <span class="pre">the</span> <span class="pre">test</span> <span class="pre">is</span> <span class="pre">tagged</span> <span class="pre">with</span> <span class="pre">one</span> <span class="pre">(and</span> <span class="pre">only</span> <span class="pre">one)</span>
<span class="pre">``:avocado:</span> <span class="pre">tags=cpu:VALUE</span></code> tag, it will be set to <code class="docutils literal notranslate"><span class="pre">VALUE</span></code>.</p>
</section>
<section id="machine">
<h4>machine<a class="headerlink" href="#machine" title="Link to this heading"></a></h4>
<p>The machine type that will be set to all QEMUMachine instances created
by the test.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">machine</span></code> attribute will be set to the test parameter of the same
name.  If one is not given explicitly, it will either be set to
<code class="docutils literal notranslate"><span class="pre">None</span></code>, or, if the test is tagged with one (and only one)
<code class="docutils literal notranslate"><span class="pre">:avocado:</span> <span class="pre">tags=machine:VALUE</span></code> tag, it will be set to <code class="docutils literal notranslate"><span class="pre">VALUE</span></code>.</p>
</section>
<section id="qemu-bin">
<h4>qemu_bin<a class="headerlink" href="#qemu-bin" title="Link to this heading"></a></h4>
<p>The preserved value of the <code class="docutils literal notranslate"><span class="pre">qemu_bin</span></code> parameter or the result of the
dynamic probe for a QEMU binary in the current working directory or
source tree.</p>
</section>
</section>
<section id="linuxtest">
<h3>LinuxTest<a class="headerlink" href="#linuxtest" title="Link to this heading"></a></h3>
<p>Besides the attributes present on the <code class="docutils literal notranslate"><span class="pre">avocado_qemu.QemuSystemTest</span></code> base
class, the <code class="docutils literal notranslate"><span class="pre">avocado_qemu.LinuxTest</span></code> adds the following attributes:</p>
<section id="distro">
<h4>distro<a class="headerlink" href="#distro" title="Link to this heading"></a></h4>
<p>The name of the Linux distribution used as the guest image for the
test.  The name should match the <strong>Provider</strong> column on the list
of images supported by the avocado.utils.vmimage library:</p>
<p><a class="reference external" href="https://avocado-framework.readthedocs.io/en/latest/guides/writer/libs/vmimage.html#supported-images">https://avocado-framework.readthedocs.io/en/latest/guides/writer/libs/vmimage.html#supported-images</a></p>
</section>
<section id="distro-version">
<h4>distro_version<a class="headerlink" href="#distro-version" title="Link to this heading"></a></h4>
<p>The version of the Linux distribution as the guest image for the
test.  The name should match the <strong>Version</strong> column on the list
of images supported by the avocado.utils.vmimage library:</p>
<p><a class="reference external" href="https://avocado-framework.readthedocs.io/en/latest/guides/writer/libs/vmimage.html#supported-images">https://avocado-framework.readthedocs.io/en/latest/guides/writer/libs/vmimage.html#supported-images</a></p>
</section>
<section id="distro-checksum">
<h4>distro_checksum<a class="headerlink" href="#distro-checksum" title="Link to this heading"></a></h4>
<p>The sha256 hash of the guest image file used for the test.</p>
<p>If this value is not set in the code or by a test parameter (with the
same name), no validation on the integrity of the image will be
performed.</p>
</section>
</section>
</section>
<section id="parameter-reference">
<h2>Parameter reference<a class="headerlink" href="#parameter-reference" title="Link to this heading"></a></h2>
<p>To understand how Avocado parameters are accessed by tests, and how
they can be passed to tests, please refer to:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">avocado</span><span class="o">-</span><span class="n">framework</span><span class="o">.</span><span class="n">readthedocs</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">en</span><span class="o">/</span><span class="n">latest</span><span class="o">/</span><span class="n">guides</span><span class="o">/</span><span class="n">writer</span><span class="o">/</span><span class="n">chapters</span><span class="o">/</span><span class="n">writing</span><span class="o">.</span><span class="n">html</span><span class="c1">#accessing-test-parameters</span>
</pre></div>
</div>
<p>Parameter values can be easily seen in the log files, and will look
like the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PARAMS</span> <span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">qemu_bin</span><span class="p">,</span> <span class="n">path</span><span class="o">=*</span><span class="p">,</span> <span class="n">default</span><span class="o">=./</span><span class="n">qemu</span><span class="o">-</span><span class="n">system</span><span class="o">-</span><span class="n">x86_64</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="s1">&#39;./qemu-system-x86_64</span>
</pre></div>
</div>
<section id="id1">
<h3>Test<a class="headerlink" href="#id1" title="Link to this heading"></a></h3>
<section id="id2">
<h4>arch<a class="headerlink" href="#id2" title="Link to this heading"></a></h4>
<p>The architecture that will influence the selection of a QEMU binary
(when one is not explicitly given).</p>
<p>Tests are also free to use this parameter value, for their own needs.
A test may, for instance, use the same value when selecting the
architecture of a kernel or disk image to boot a VM with.</p>
<p>This parameter has a direct relation with the <code class="docutils literal notranslate"><span class="pre">arch</span></code> attribute.  If
not given, it will default to None.</p>
</section>
<section id="id3">
<h4>cpu<a class="headerlink" href="#id3" title="Link to this heading"></a></h4>
<p>The cpu model that will be set to all QEMUMachine instances created
by the test.</p>
</section>
<section id="id4">
<h4>machine<a class="headerlink" href="#id4" title="Link to this heading"></a></h4>
<p>The machine type that will be set to all QEMUMachine instances created
by the test.</p>
</section>
<section id="id5">
<h4>qemu_bin<a class="headerlink" href="#id5" title="Link to this heading"></a></h4>
<p>The exact QEMU binary to be used on QEMUMachine.</p>
</section>
</section>
<section id="id6">
<h3>LinuxTest<a class="headerlink" href="#id6" title="Link to this heading"></a></h3>
<p>Besides the parameters present on the <code class="docutils literal notranslate"><span class="pre">avocado_qemu.QemuSystemTest</span></code> base
class, the <code class="docutils literal notranslate"><span class="pre">avocado_qemu.LinuxTest</span></code> adds the following parameters:</p>
<section id="id7">
<h4>distro<a class="headerlink" href="#id7" title="Link to this heading"></a></h4>
<p>The name of the Linux distribution used as the guest image for the
test.  The name should match the <strong>Provider</strong> column on the list
of images supported by the avocado.utils.vmimage library:</p>
<p><a class="reference external" href="https://avocado-framework.readthedocs.io/en/latest/guides/writer/libs/vmimage.html#supported-images">https://avocado-framework.readthedocs.io/en/latest/guides/writer/libs/vmimage.html#supported-images</a></p>
</section>
<section id="id8">
<h4>distro_version<a class="headerlink" href="#id8" title="Link to this heading"></a></h4>
<p>The version of the Linux distribution as the guest image for the
test.  The name should match the <strong>Version</strong> column on the list
of images supported by the avocado.utils.vmimage library:</p>
<p><a class="reference external" href="https://avocado-framework.readthedocs.io/en/latest/guides/writer/libs/vmimage.html#supported-images">https://avocado-framework.readthedocs.io/en/latest/guides/writer/libs/vmimage.html#supported-images</a></p>
</section>
<section id="id9">
<h4>distro_checksum<a class="headerlink" href="#id9" title="Link to this heading"></a></h4>
<p>The sha256 hash of the guest image file used for the test.</p>
<p>If this value is not set in the code or by this parameter no
validation on the integrity of the image will be performed.</p>
</section>
</section>
</section>
<section id="skipping-tests">
<h2>Skipping tests<a class="headerlink" href="#skipping-tests" title="Link to this heading"></a></h2>
<p>The Avocado framework provides Python decorators which allow for easily skip
tests running under certain conditions. For example, on the lack of a binary
on the test system or when the running environment is a CI system. For further
information about those decorators, please refer to:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">avocado</span><span class="o">-</span><span class="n">framework</span><span class="o">.</span><span class="n">readthedocs</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">en</span><span class="o">/</span><span class="n">latest</span><span class="o">/</span><span class="n">guides</span><span class="o">/</span><span class="n">writer</span><span class="o">/</span><span class="n">chapters</span><span class="o">/</span><span class="n">writing</span><span class="o">.</span><span class="n">html</span><span class="c1">#skipping-tests</span>
</pre></div>
</div>
<p>While the conditions for skipping tests are often specifics of each one, there
are recurring scenarios identified by the QEMU developers and the use of
environment variables became a kind of standard way to enable/disable tests.</p>
<p>Here is a list of the most used variables:</p>
<section id="avocado-allow-large-storage">
<h3>AVOCADO_ALLOW_LARGE_STORAGE<a class="headerlink" href="#avocado-allow-large-storage" title="Link to this heading"></a></h3>
<p>Tests which are going to fetch or produce assets considered <em>large</em> are not
going to run unless that <code class="docutils literal notranslate"><span class="pre">AVOCADO_ALLOW_LARGE_STORAGE=1</span></code> is exported on
the environment.</p>
<p>The definition of <em>large</em> is a bit arbitrary here, but it usually means an
asset which occupies at least 1GB of size on disk when uncompressed.</p>
</section>
<section id="speed">
<h3>SPEED<a class="headerlink" href="#speed" title="Link to this heading"></a></h3>
<p>Tests which have a long runtime will not be run unless <code class="docutils literal notranslate"><span class="pre">SPEED=slow</span></code> is
exported on the environment.</p>
<p>The definition of <em>long</em> is a bit arbitrary here, and it depends on the
usefulness of the test too. A unique test is worth spending more time on,
small variations on existing tests perhaps less so. As a rough guide,
a test or set of similar tests which take more than 100 seconds to
complete.</p>
</section>
<section id="avocado-allow-untrusted-code">
<h3>AVOCADO_ALLOW_UNTRUSTED_CODE<a class="headerlink" href="#avocado-allow-untrusted-code" title="Link to this heading"></a></h3>
<p>There are tests which will boot a kernel image or firmware that can be
considered not safe to run on the developer's workstation, thus they are
skipped by default. The definition of <em>not safe</em> is also arbitrary but
usually it means a blob which either its source or build process aren't
public available.</p>
<p>You should export <code class="docutils literal notranslate"><span class="pre">AVOCADO_ALLOW_UNTRUSTED_CODE=1</span></code> on the environment in
order to allow tests which make use of those kind of assets.</p>
</section>
<section id="avocado-timeout-expected">
<h3>AVOCADO_TIMEOUT_EXPECTED<a class="headerlink" href="#avocado-timeout-expected" title="Link to this heading"></a></h3>
<p>The Avocado framework has a timeout mechanism which interrupts tests to avoid the
test suite of getting stuck. The timeout value can be set via test parameter or
property defined in the test class, for further details:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">avocado</span><span class="o">-</span><span class="n">framework</span><span class="o">.</span><span class="n">readthedocs</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">en</span><span class="o">/</span><span class="n">latest</span><span class="o">/</span><span class="n">guides</span><span class="o">/</span><span class="n">writer</span><span class="o">/</span><span class="n">chapters</span><span class="o">/</span><span class="n">writing</span><span class="o">.</span><span class="n">html</span><span class="c1">#setting-a-test-timeout</span>
</pre></div>
</div>
<p>Even though the timeout can be set by the test developer, there are some tests
that may not have a well-defined limit of time to finish under certain
conditions. For example, tests that take longer to execute when QEMU is
compiled with debug flags. Therefore, the <code class="docutils literal notranslate"><span class="pre">AVOCADO_TIMEOUT_EXPECTED</span></code> variable
has been used to determine whether those tests should run or not.</p>
</section>
<section id="qemu-test-flaky-tests">
<h3>QEMU_TEST_FLAKY_TESTS<a class="headerlink" href="#qemu-test-flaky-tests" title="Link to this heading"></a></h3>
<p>Some tests are not working reliably and thus are disabled by default.
This includes tests that don't run reliably on GitLab's CI which
usually expose real issues that are rarely seen on developer machines
due to the constraints of the CI environment. If you encounter a
similar situation then raise a bug and then mark the test as shown on
the code snippet below:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># See https://gitlab.com/qemu-project/qemu/-/issues/nnnn</span>
<span class="nd">@skipUnless</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;QEMU_TEST_FLAKY_TESTS&#39;</span><span class="p">),</span> <span class="s1">&#39;Test is unstable on GitLab&#39;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">do_something</span><span class="p">()</span>
</pre></div>
</div>
<p>You can also add <code class="docutils literal notranslate"><span class="pre">:avocado:</span> <span class="pre">tags=flaky</span></code> to the test meta-data so
only the flaky tests can be run as a group:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">env</span> <span class="n">QEMU_TEST_FLAKY_TESTS</span><span class="o">=</span><span class="mi">1</span> <span class="o">./</span><span class="n">pyvenv</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">avocado</span> \
   <span class="n">run</span> <span class="n">tests</span><span class="o">/</span><span class="n">avocado</span> <span class="o">-</span><span class="nb">filter</span><span class="o">-</span><span class="n">by</span><span class="o">-</span><span class="n">tags</span><span class="o">=</span><span class="n">flaky</span>
</pre></div>
</div>
<p>Tests should not live in this state forever and should either be fixed
or eventually removed.</p>
</section>
</section>
<section id="uninstalling-avocado">
<h2>Uninstalling Avocado<a class="headerlink" href="#uninstalling-avocado" title="Link to this heading"></a></h2>
<p>If you've followed the manual installation instructions above, you can
easily uninstall Avocado.  Start by listing the packages you have
installed:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pip</span> <span class="nb">list</span> <span class="o">--</span><span class="n">user</span>
</pre></div>
</div>
<p>And remove any package you want with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pip</span> <span class="n">uninstall</span> <span class="o">&lt;</span><span class="n">package_name</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>If you've used <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">check-avocado</span></code>, the Python virtual environment where
Avocado is installed will be cleaned up as part of <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">check-clean</span></code>.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="页脚">
        <a href="functional.html" class="btn btn-neutral float-left" title="Functional testing with Python" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> 上一页</a>
        <a href="acpi-bits.html" class="btn btn-neutral float-right" title="ACPI/SMBIOS testing using biosbits" accesskey="n" rel="next">下一页 <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 2024, The QEMU Project Developers。</p>
  </div>

  利用 <a href="https://www.sphinx-doc.org/">Sphinx</a> 构建，使用的 
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">主题</a>
    由 <a href="https://readthedocs.org">Read the Docs</a> 开发.
  

<!-- Empty para to force a blank line after "Built with Sphinx ..." -->
<p></p>

<p>This documentation is for QEMU version 9.2.</p>


<p><a href="../../about/license.html">QEMU and this manual are released under the
GNU General Public License, version 2.</a></p>

 


</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>