<!DOCTYPE html>

<html lang="en-US" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Persistent reservation managers &#8212; QEMU 4.0.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="_static/basic.css?v=686e5160" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css?v=27fed22d" />
    <script src="_static/documentation_options.js?v=b1ba0fa7"></script>
    <script src="_static/doctools.js?v=9bcbadda"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="canonical" href="https://projects.localizethedocs.org/qemu-docs-l10n/pr-manager.html" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />

   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  

  
  

<script type="text/javascript" src="ltd-provenance.js"></script>
<script type="text/javascript" src="ltd-current.js"></script>
<script type="text/javascript" src="../../ltd-config.js"></script>
<script type="text/javascript" src="../../ltd-flyout.js"></script>

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="persistent-reservation-managers">
<h1>Persistent reservation managers<a class="headerlink" href="#persistent-reservation-managers" title="Link to this heading">¶</a></h1>
<p>SCSI persistent Reservations allow restricting access to block devices
to specific initiators in a shared storage setup.  When implementing
clustering of virtual machines, it is a common requirement for virtual
machines to send persistent reservation SCSI commands.  However,
the operating system restricts sending these commands to unprivileged
programs because incorrect usage can disrupt regular operation of the
storage fabric.</p>
<p>For this reason, QEMU’s SCSI passthrough devices, <code class="docutils literal notranslate"><span class="pre">scsi-block</span></code>
and <code class="docutils literal notranslate"><span class="pre">scsi-generic</span></code> (both are only available on Linux) can delegate
implementation of persistent reservations to a separate object,
the “persistent reservation manager”.  Only PERSISTENT RESERVE OUT and
PERSISTENT RESERVE IN commands are passed to the persistent reservation
manager object; other commands are processed by QEMU as usual.</p>
<section id="defining-a-persistent-reservation-manager">
<h2>Defining a persistent reservation manager<a class="headerlink" href="#defining-a-persistent-reservation-manager" title="Link to this heading">¶</a></h2>
<p>A persistent reservation manager is an instance of a subclass of the
“pr-manager” QOM class.</p>
<p>Right now only one subclass is defined, <code class="docutils literal notranslate"><span class="pre">pr-manager-helper</span></code>, which
forwards the commands to an external privileged helper program
over Unix sockets.  The helper program only allows sending persistent
reservation commands to devices for which QEMU has a file descriptor,
so that QEMU will not be able to effect persistent reservations
unless it has access to both the socket and the device.</p>
<p><code class="docutils literal notranslate"><span class="pre">pr-manager-helper</span></code> has a single string property, <code class="docutils literal notranslate"><span class="pre">path</span></code>, which
accepts the path to the helper program’s Unix socket.  For example,
the following command line defines a <code class="docutils literal notranslate"><span class="pre">pr-manager-helper</span></code> object and
attaches it to a SCSI passthrough device:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ qemu-system-x86_64
    -device virtio-scsi \
    -object pr-manager-helper,id=helper0,path=/var/run/qemu-pr-helper.sock
    -drive if=none,id=hd,driver=raw,file.filename=/dev/sdb,file.pr-manager=helper0
    -device scsi-block,drive=hd
</pre></div>
</div>
<p>Alternatively, using <code class="docutils literal notranslate"><span class="pre">-blockdev</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ qemu-system-x86_64
    -device virtio-scsi \
    -object pr-manager-helper,id=helper0,path=/var/run/qemu-pr-helper.sock
    -blockdev node-name=hd,driver=raw,file.driver=host_device,file.filename=/dev/sdb,file.pr-manager=helper0
    -device scsi-block,drive=hd
</pre></div>
</div>
</section>
<section id="invoking-qemu-pr-helper">
<h2>Invoking <strong class="program">qemu-pr-helper</strong><a class="headerlink" href="#invoking-qemu-pr-helper" title="Link to this heading">¶</a></h2>
<p>QEMU provides an implementation of the persistent reservation helper,
called <strong class="program">qemu-pr-helper</strong>.  The helper should be started as a
system service and supports the following option:</p>
<dl class="option-list">
<dt><kbd><span class="option">-d</span>, <span class="option">--daemon</span></kbd></dt>
<dd><p>run in the background</p>
</dd>
<dt><kbd><span class="option">-q</span>, <span class="option">--quiet</span></kbd></dt>
<dd><p>decrease verbosity</p>
</dd>
<dt><kbd><span class="option">-v</span>, <span class="option">--verbose</span></kbd></dt>
<dd><p>increase verbosity</p>
</dd>
<dt><kbd><span class="option">-f</span>, <span class="option">--pidfile=<var>path</var></span></kbd></dt>
<dd><p>PID file when running as a daemon</p>
</dd>
<dt><kbd><span class="option">-k</span>, <span class="option">--socket=<var>path</var></span></kbd></dt>
<dd><p>path to the socket</p>
</dd>
<dt><kbd><span class="option">-T</span>, <span class="option">--trace=<var>trace-opts</var></span></kbd></dt>
<dd><p>tracing options</p>
</dd>
</dl>
<p>By default, the socket and PID file are placed in the runtime state
directory, for example <code class="file docutils literal notranslate"><span class="pre">/var/run/qemu-pr-helper.sock</span></code> and
<code class="file docutils literal notranslate"><span class="pre">/var/run/qemu-pr-helper.pid</span></code>.  The PID file is not created
unless <code class="xref std std-option docutils literal notranslate"><span class="pre">-d</span></code> is passed too.</p>
<p><strong class="program">qemu-pr-helper</strong> can also use the systemd socket activation
protocol.  In this case, the systemd socket unit should specify a
Unix stream socket, like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">Socket</span><span class="p">]</span>
<span class="n">ListenStream</span><span class="o">=/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">qemu</span><span class="o">-</span><span class="n">pr</span><span class="o">-</span><span class="n">helper</span><span class="o">.</span><span class="n">sock</span>
</pre></div>
</div>
<p>After connecting to the socket, <strong class="program">qemu-pr-helper`</strong> can optionally drop
root privileges, except for those capabilities that are needed for
its operation.  To do this, add the following options:</p>
<dl class="option-list">
<dt><kbd><span class="option">-u</span>, <span class="option">--user=<var>user</var></span></kbd></dt>
<dd><p>user to drop privileges to</p>
</dd>
<dt><kbd><span class="option">-g</span>, <span class="option">--group=<var>group</var></span></kbd></dt>
<dd><p>group to drop privileges to</p>
</dd>
</dl>
</section>
<section id="multipath-devices-and-persistent-reservations">
<h2>Multipath devices and persistent reservations<a class="headerlink" href="#multipath-devices-and-persistent-reservations" title="Link to this heading">¶</a></h2>
<p>Proper support of persistent reservation for multipath devices requires
communication with the multipath daemon, so that the reservation is
registered and applied when a path is newly discovered or becomes online
again.  <strong class="command">qemu-pr-helper</strong> can do this if the <code class="docutils literal notranslate"><span class="pre">libmpathpersist</span></code>
library was available on the system at build time.</p>
<p>As of August 2017, a reservation key must be specified in <code class="docutils literal notranslate"><span class="pre">multipath.conf</span></code>
for <code class="docutils literal notranslate"><span class="pre">multipathd</span></code> to check for persistent reservation for newly
discovered paths or reinstated paths.  The attribute can be added
to the <code class="docutils literal notranslate"><span class="pre">defaults</span></code> section or the <code class="docutils literal notranslate"><span class="pre">multipaths</span></code> section; for example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">multipaths</span> <span class="p">{</span>
    <span class="n">multipath</span> <span class="p">{</span>
        <span class="n">wwid</span>   <span class="n">XXXXXXXXXXXXXXXX</span>
        <span class="n">alias</span>      <span class="n">yellow</span>
        <span class="n">reservation_key</span>  <span class="mh">0x123abc</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Linking <strong class="program">qemu-pr-helper</strong> to <code class="docutils literal notranslate"><span class="pre">libmpathpersist</span></code> does not impede
its usage on regular SCSI devices.</p>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">QEMU</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="interop/index.html">QEMU System Emulation Management and Interoperability Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="devel/index.html">QEMU Developer’s Guide</a></li>
</ul>


<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2019, The QEMU Project Developers.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 8.1.2</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 1.0.0</a>
      
    </div>

    

    
  </body>
</html>